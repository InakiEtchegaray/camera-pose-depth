<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream de Cámara con Pose y Profundidad</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stream de Cámara con Pose y Profundidad</h1>
        </div>
        <div id="videoContainer">
            <video id="video" autoplay playsinline></video>
            <div id="stats"></div>
        </div>
        <div id="status" class="connecting">Iniciando conexión...</div>
    </div>

    <script>
        let pc = null;
        const status = document.getElementById('status');
        const video = document.getElementById('video');
        const stats = document.getElementById('stats');
        
        async function startStream() {
            if (pc) {
                pc.close();
            }
            
            status.textContent = 'Conectando...';
            status.className = 'connecting';
            
            try {
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                });
                
                pc.oniceconnectionstatechange = () => {
                    status.textContent = 'Estado: ' + pc.iceConnectionState;
                    if (pc.iceConnectionState === 'connected') {
                        status.className = 'success';
                    }
                };
                
                pc.ontrack = function(event) {
                    status.textContent = 'Conectado';
                    status.className = 'success';
                    video.srcObject = event.streams[0];
                };
                
                const offer = await pc.createOffer({
                    offerToReceiveVideo: true,
                    offerToReceiveAudio: false
                });
                
                await pc.setLocalDescription(offer);
                
                const response = await fetch('/offer', {
                    body: JSON.stringify({
                        sdp: pc.localDescription.sdp,
                        type: pc.localDescription.type
                    }),
                    headers: {'Content-Type': 'application/json'},
                    method: 'POST'
                });
                
                const answer = await response.json();
                await pc.setRemoteDescription(answer);
                
            } catch (e) {
                status.textContent = 'Error: ' + e.toString();
                status.className = 'error';
                console.error(e);
            }
        }
        
        startStream();
        
        setInterval(async () => {
            if (pc && video.srcObject) {
                const stats = await pc.getStats();
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.kind === 'video') {
                        document.getElementById('stats').textContent = 
                            `FPS: ${report.framesPerSecond || 0}`;
                    }
                });
            }
        }, 1000);
    </script>
</body>
</html>
